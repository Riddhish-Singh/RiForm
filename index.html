<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiForm Builder v3.0 Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        try {
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            teal: { 50: '#f0fdfa', 100: '#ccfbf1', 600: '#0d9488', 700: '#0f766e', 900: '#134e4a' },
                            indigo: { 50: '#eef2ff', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                            rose: { 50: '#fff1f2', 600: '#e11d48', 700: '#be123c', 900: '#881337' },
                            amber: { 50: '#fffbeb', 600: '#d97706', 700: '#b45309', 900: '#78350f' },
                            slate: { 50: '#f8fafc', 800: '#1e293b', 900: '#0f172a' }
                        }
                    }
                }
            }
        } catch(e) { console.warn("Tailwind config failed", e); }
    </script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: #0d9488;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer; background: #e2e8f0; border-radius: 2px;
        }
        
        /* Signature Pad */
        canvas.signature-pad {
            touch-action: none;
            cursor: crosshair;
            background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden flex flex-col">

    <div id="app" class="flex-1 flex flex-col h-full overflow-hidden relative">
        <div id="loading" class="absolute inset-0 flex items-center justify-center bg-gray-50 z-50">
            <div class="text-center">
                <div class="text-teal-600 mb-4 mx-auto text-4xl font-bold animate-bounce">...</div>
                <div class="text-gray-500 font-medium">Loading RiForm v3.0...</div>
            </div>
        </div>
    </div>

    <script>
        // Global Error Handler
        window.onerror = function(msg, url, line) {
            console.error("Error: " + msg + "\nLine: " + line);
            const el = document.getElementById('loading');
            if(el) el.style.display = 'none';
        };

        // --- Configuration & Storage ---
        const STORAGE_KEYS = {
            FORMS: 'riform_v3_forms',
            RESPONSES: 'riform_v3_responses'
        };

        const ADMIN_PASSWORD = '123';

        // --- State Management ---
        const state = {
            user: { uid: 'local_user', name: 'User' },
            view: 'roleSelection', 
            role: null, 
            activeFormId: null,
            forms: [],
            currentForm: null, 
            responses: [], 
            builderTab: 'questions', 
            logicMenuOpenId: null, 
            timerInterval: null
        };

        // --- Constants ---
        const THEMES = [
            { id: 'teal', primary: 'bg-teal-600', secondary: 'bg-teal-50', border: 'border-teal-200', text: 'text-teal-900', hover: 'hover:bg-teal-700' },
            { id: 'indigo', primary: 'bg-indigo-600', secondary: 'bg-indigo-50', border: 'border-indigo-200', text: 'text-indigo-900', hover: 'hover:bg-indigo-700' },
            { id: 'rose', primary: 'bg-rose-600', secondary: 'bg-rose-50', border: 'border-rose-200', text: 'text-rose-900', hover: 'hover:bg-rose-700' },
            { id: 'amber', primary: 'bg-amber-600', secondary: 'bg-amber-50', border: 'border-amber-200', text: 'text-amber-900', hover: 'hover:bg-amber-700' },
            { id: 'slate', primary: 'bg-slate-800', secondary: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-900', hover: 'hover:bg-slate-900' },
        ];

        const QUESTION_TYPES = [
            { id: 'text', label: 'Short Text', icon: 'type' },
            { id: 'paragraph', label: 'Long Paragraph', icon: 'align-justify' },
            { id: 'email', label: 'Email', icon: 'mail' },
            { id: 'choice', label: 'Multiple Choice', icon: 'check-square' },
            { id: 'range', label: 'Slider Range', icon: 'sliders' },
            { id: 'rating', label: 'Star Rating', icon: 'star' },
            { id: 'date', label: 'Date', icon: 'calendar' },
            { id: 'file', label: 'File Upload', icon: 'upload-cloud' }, // NEW
            { id: 'signature', label: 'Signature', icon: 'pen-tool' }, // NEW
            { id: 'likert', label: 'Likert Scale', icon: 'list' },
            { id: 'nps', label: 'NPS Score', icon: 'bar-chart' },
        ];

        // --- Helpers ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const escapeHtml = (unsafe) => {
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        // --- Local Storage Helpers ---
        function getLocalForms() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.FORMS) || '[]'); } catch (e) { return []; }
        }

        function saveLocalForms(forms) {
            localStorage.setItem(STORAGE_KEYS.FORMS, JSON.stringify(forms));
        }

        function getLocalResponses() {
            try { return JSON.parse(localStorage.getItem(STORAGE_KEYS.RESPONSES) || '[]'); } catch (e) { return []; }
        }

        function saveLocalResponse(response) {
            const responses = getLocalResponses();
            responses.push(response);
            try {
                localStorage.setItem(STORAGE_KEYS.RESPONSES, JSON.stringify(responses));
            } catch(e) {
                alert("Storage Full! Cannot save response including large files.");
            }
        }

        // --- Init Function ---
        function initApp() {
            setTimeout(() => {
                const loadingEl = document.getElementById('loading');
                if (loadingEl) loadingEl.style.display = 'none';
                render(); 
            }, 500); 
        }

        initApp();

        // --- Routing / View Rendering ---
        function render() {
            const appDiv = document.getElementById('app');
            if(!appDiv) return;
            appDiv.innerHTML = ''; 

            if (state.view === 'roleSelection') renderRoleSelection(appDiv);
            else if (state.view === 'dashboard') renderDashboard(appDiv);
            else if (state.view === 'builder') renderBuilder(appDiv);
            else if (state.view === 'preview') renderViewer(appDiv, state.role === 'admin'); 
            else if (state.view === 'results') renderResults(appDiv);
            else if (state.view === 'access_lock') renderAccessLock(appDiv);

            if(window.lucide) {
                try { lucide.createIcons(); } catch(e) {}
            }
            
            if (state.view === 'preview') {
                window.evaluateLogic();
                window.updateProgressBar();
                window.initSignaturePads(); // Init canvas
            }
        }

        // --- Role Selection View ---
        function renderRoleSelection(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-gray-50 p-4">
                    <div class="mb-8 text-center">
                        <div class="flex items-center justify-center gap-2 mb-2">
                             <i data-lucide="layout" class="w-10 h-10 text-teal-600"></i>
                             <h1 class="text-4xl font-bold text-gray-800">RiForm v3</h1>
                        </div>
                        <p class="text-gray-500">Enhanced Builder</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-2xl w-full">
                        <button onclick="window.selectRole('participant')" class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 hover:shadow-lg hover:border-teal-500 transition group text-left">
                            <div class="bg-blue-50 w-12 h-12 rounded-lg flex items-center justify-center mb-4 group-hover:bg-blue-100 transition">
                                <i data-lucide="user" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Participant</h2>
                            <p class="text-gray-500 text-sm">I want to fill out a form or take a quiz.</p>
                        </button>

                        <button onclick="window.openAdminModal()" class="bg-white p-8 rounded-xl shadow-sm border border-gray-200 hover:shadow-lg hover:border-teal-500 transition group text-left">
                            <div class="bg-purple-50 w-12 h-12 rounded-lg flex items-center justify-center mb-4 group-hover:bg-purple-100 transition">
                                <i data-lucide="shield" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Admin</h2>
                            <p class="text-gray-500 text-sm">Create forms. (Password: hijikilio)</p>
                        </button>
                    </div>

                    <div id="admin-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
                        <div class="bg-white rounded-xl shadow-xl p-8 max-w-sm w-full mx-4 fade-in">
                            <h3 class="text-lg font-bold mb-4">Admin Access</h3>
                            <input type="password" id="admin-pass" class="w-full border border-gray-300 rounded p-2 mb-4 outline-none focus:ring-2 focus:ring-teal-500" placeholder="Enter Password">
                            <div class="flex justify-end gap-2">
                                <button onclick="document.getElementById('admin-modal').classList.remove('flex'); document.getElementById('admin-modal').classList.add('hidden');" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">Cancel</button>
                                <button onclick="window.verifyAdmin()" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">Login</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        window.openAdminModal = () => {
            const modal = document.getElementById('admin-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => document.getElementById('admin-pass').focus(), 100);
        };

        window.verifyAdmin = () => {
            const input = document.getElementById('admin-pass').value;
            if (input === ADMIN_PASSWORD) {
                window.selectRole('admin');
            } else {
                alert("Incorrect Password!");
                document.getElementById('admin-pass').value = '';
            }
        };

        window.selectRole = (role) => {
            state.role = role;
            state.user.name = role === 'admin' ? 'Administrator' : 'Participant';
            mountDashboard();
        };

        window.logout = () => {
            state.role = null;
            state.view = 'roleSelection';
            render();
        };

        // --- Dashboard View ---
        function mountDashboard() {
            if(state.timerInterval) clearInterval(state.timerInterval);
            state.forms = getLocalForms().sort((a, b) => b.updatedAt - a.updatedAt);
            state.view = 'dashboard';
            render();
        }

        function renderDashboard(container) {
            const isAdmin = state.role === 'admin';
            let html = `
                <div class="p-8 max-w-6xl mx-auto w-full overflow-y-auto">
                    <div class="flex justify-between items-center mb-8">
                        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                            <i data-lucide="layout" class="w-8 h-8 text-teal-600"></i> RiForm 
                            <span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded ml-2 uppercase">${state.role}</span>
                        </h1>
                        <div class="flex gap-2 items-center">
                            ${isAdmin ? `
                            <button onclick="window.createForm('quiz')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md flex items-center gap-2 transition shadow-sm">
                                <i data-lucide="plus" class="w-4 h-4"></i> New Quiz
                            </button>
                            <button onclick="window.createForm('form')" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-md flex items-center gap-2 transition shadow-sm">
                                <i data-lucide="plus" class="w-4 h-4"></i> New Form
                            </button>
                            <div class="w-px h-6 bg-gray-300 mx-2"></div>
                            ` : ''}
                            <button onclick="window.logout()" class="text-gray-500 hover:text-red-600 flex items-center gap-1 font-medium text-sm">
                                <i data-lucide="log-out" class="w-4 h-4"></i> Logout
                            </button>
                        </div>
                    </div>
            `;

            if (state.forms.length === 0) {
                html += `
                    <div class="text-center py-20 bg-white rounded-xl border-2 border-dashed border-gray-300">
                        <p class="text-gray-500 mb-4">No forms available.</p>
                        ${isAdmin ? '<p class="text-xs text-gray-400">Create one to get started!</p>' : ''}
                    </div>
                `;
            } else {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                state.forms.forEach(form => {
                    const theme = THEMES.find(t => t.id === form.theme) || THEMES[0];
                    const dateStr = form.updatedAt ? new Date(form.updatedAt).toLocaleDateString() : 'Just now';
                    
                    const bgStyle = form.backgroundImage 
                        ? `background-image: url('${form.backgroundImage}'); background-size: cover;` 
                        : form.backgroundColor 
                            ? `background-color: ${form.backgroundColor};`
                            : '';
                    const bgClass = (!form.backgroundImage && !form.backgroundColor) ? theme.primary : '';
                    
                    // Logic to check lock
                    const clickAction = isAdmin ? `window.openBuilder('${form.id}')` : `window.checkAccess('${form.id}')`;

                    html += `
                        <div onclick="${clickAction}" class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition cursor-pointer group flex flex-col h-48 fade-in relative overflow-hidden">
                            <div class="h-2 w-full rounded-t-xl ${bgClass}" style="${bgStyle}"></div>
                            <div class="p-5 flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-semibold text-lg text-gray-800 truncate pr-4 flex items-center gap-1">
                                        ${form.settings.accessPassword ? '<i data-lucide="lock" class="w-3 h-3 text-red-500"></i>' : ''}
                                        ${escapeHtml(form.title)}
                                    </h3>
                                    ${form.settings.isQuiz ? '<span class="bg-purple-100 text-purple-700 text-xs px-2 py-0.5 rounded-full font-medium">Quiz</span>' : ''}
                                </div>
                                <p class="text-gray-500 text-sm mt-1 line-clamp-2">${escapeHtml(form.description)}</p>
                                <div class="mt-4 text-xs text-gray-400 flex gap-2">
                                    <span>Updated ${dateStr}</span>
                                    ${form.settings.timeLimit ? `<span>â€¢ ${form.settings.timeLimit}m limit</span>` : ''}
                                </div>
                            </div>
                            
                            ${isAdmin ? `
                            <div class="border-t border-gray-100 p-3 flex justify-between items-center bg-gray-50 rounded-b-xl z-10 relative">
                                <div class="flex gap-2">
                                    <button onclick="event.stopPropagation(); window.openResults('${form.id}')" class="p-1.5 hover:bg-gray-200 rounded text-gray-600" title="Results / Analytics"><i data-lucide="bar-chart" class="w-4 h-4"></i></button>
                                    <button onclick="event.stopPropagation(); window.openPreview('${form.id}')" class="p-1.5 hover:bg-gray-200 rounded text-gray-600" title="Preview"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                    <button onclick="event.stopPropagation(); window.duplicateForm('${form.id}')" class="p-1.5 hover:bg-blue-100 hover:text-blue-600 rounded text-gray-600" title="Duplicate Form"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                </div>
                                <button onclick="window.deleteForm(event, '${form.id}')" class="p-1.5 hover:bg-red-100 hover:text-red-600 rounded text-gray-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>` 
                            : `
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition"></div>
                            <div class="absolute bottom-4 right-4 bg-white/90 backdrop-blur text-teal-700 px-3 py-1 rounded shadow-sm text-sm font-medium opacity-0 group-hover:opacity-100 transition translate-y-2 group-hover:translate-y-0">
                                Start &rarr;
                            </div>
                            `}
                        </div>
                    `;
                });
                html += `</div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- Password Check View ---
        function renderAccessLock(container) {
            container.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <div class="bg-white p-8 rounded-lg shadow-lg border-t-4 border-red-500 max-w-sm w-full">
                        <h2 class="text-xl font-bold mb-2">Restricted Access</h2>
                        <p class="text-gray-500 text-sm mb-4">This form is password protected.</p>
                        <input type="password" id="form-access-pass" class="w-full border p-2 rounded mb-4" placeholder="Password">
                        <div class="flex justify-between">
                            <button onclick="window.loadDashboard()" class="text-gray-500">Cancel</button>
                            <button onclick="window.verifyFormAccess()" class="bg-red-500 text-white px-4 py-2 rounded">Unlock</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.checkAccess = (id) => {
            const form = getLocalForms().find(f => f.id === id);
            if (form.settings.accessPassword) {
                state.activeFormId = id;
                state.view = 'access_lock';
                render();
            } else {
                window.openPreview(id);
            }
        };

        window.verifyFormAccess = () => {
             const form = getLocalForms().find(f => f.id === state.activeFormId);
             const input = document.getElementById('form-access-pass').value;
             if (input === form.settings.accessPassword) {
                 window.openPreview(state.activeFormId);
             } else {
                 alert("Wrong password");
             }
        };

        // --- Builder View (Admin Only) ---
        function mountBuilder(formId) {
            if (state.role !== 'admin') {
                alert("Access Denied");
                mountDashboard();
                return;
            }
            state.view = 'builder';
            state.activeFormId = formId;
            state.builderTab = 'questions'; 
            state.logicMenuOpenId = null;
            
            const form = getLocalForms().find(f => f.id === formId);
            if (form) {
                // Backward compatibility
                if(!form.settings.thankYouMessage) form.settings.thankYouMessage = '';
                state.currentForm = form;
                render();
            } else {
                alert("Form not found");
                mountDashboard();
            }
        }

        function renderBuilder(container) {
            if (!state.currentForm) return;

            const f = state.currentForm;
            const theme = THEMES.find(t => t.id === f.theme) || THEMES[0];

            container.innerHTML = `
                <div class="flex flex-col h-screen bg-gray-100 overflow-hidden">
                    <div class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center shadow-sm z-10">
                        <div class="flex items-center gap-4">
                            <button onclick="window.loadDashboard()" class="text-gray-500 hover:bg-gray-100 p-2 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <div>
                                <input value="${escapeHtml(f.title)}" onchange="window.updateFormTitle(this.value)" class="text-lg font-bold text-gray-800 bg-transparent border-none focus:ring-0 focus:underline placeholder-gray-400 w-48 md:w-80" placeholder="Form Title" />
                                <div class="text-xs text-gray-400">Changes saved locally</div>
                            </div>
                        </div>
                        <div class="flex items-center bg-gray-100 p-1 rounded-lg">
                            <button onclick="window.setBuilderTab('questions')" class="px-4 py-1.5 rounded-md text-sm font-medium transition ${state.builderTab === 'questions' ? 'bg-white shadow text-gray-900' : 'text-gray-500 hover:text-gray-900'}">Questions</button>
                            <button onclick="window.setBuilderTab('design')" class="px-4 py-1.5 rounded-md text-sm font-medium transition ${state.builderTab === 'design' ? 'bg-white shadow text-gray-900' : 'text-gray-500 hover:text-gray-900'}">Design</button>
                            <button onclick="window.setBuilderTab('settings')" class="px-4 py-1.5 rounded-md text-sm font-medium transition ${state.builderTab === 'settings' ? 'bg-white shadow text-gray-900' : 'text-gray-500 hover:text-gray-900'}">Settings</button>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="window.downloadFormCode()" class="flex items-center gap-2 px-3 py-2 rounded-md text-gray-600 hover:bg-gray-100 transition border border-gray-200" title="Download HTML File"><i data-lucide="download" class="w-4 h-4"></i> <span class="hidden sm:inline">Export</span></button>
                             <button onclick="window.openPreview('${f.id}')" class="flex items-center gap-2 px-4 py-2 rounded-md text-white shadow-sm transition ${theme.primary} ${theme.hover}"><i data-lucide="play" class="w-4 h-4"></i> Preview</button>
                        </div>
                    </div>

                    <div class="flex flex-1 overflow-hidden">
                        ${state.builderTab === 'questions' ? `
                        <div class="w-64 bg-white border-r border-gray-200 overflow-y-auto hidden md:block">
                            <div class="p-4">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-3">Add Elements</h3>
                                <div class="space-y-2">
                                    ${QUESTION_TYPES.map(t => `
                                        <button onclick="window.addQuestion('${t.id}')" class="w-full flex items-center gap-3 px-3 py-2.5 text-left text-sm text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-100 transition group">
                                            <i data-lucide="${t.icon}" class="w-4 h-4 text-gray-400 group-hover:text-gray-800"></i> ${t.label}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>` : ''}

                        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                            <div class="max-w-3xl mx-auto space-y-4 pb-20">
                                ${renderBuilderContent(f, theme)}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBuilderContent(form, theme) {
            if (state.builderTab === 'questions') {
                return `
                    <div class="bg-white rounded-lg shadow-sm border-t-8 border border-gray-200 p-6 relative" style="border-top-color: ${theme.primary.replace('bg-', '') === 'bg-slate-800' ? '#1e293b' : ''}; border-top-class: ${theme.primary}">
                         <div class="h-2 absolute top-0 left-0 w-full rounded-t-lg -mt-2 ${theme.primary}"></div>
                         <input value="${escapeHtml(form.title)}" onchange="window.updateFormTitle(this.value)" class="w-full text-3xl font-bold border-none focus:ring-0 placeholder-gray-300 mb-2 outline-none" placeholder="Untitled Form" />
                         <textarea onchange="window.updateFormDesc(this.value)" class="w-full text-gray-600 border-none focus:ring-0 resize-none placeholder-gray-400 outline-none" placeholder="Form description (optional)" rows="2">${escapeHtml(form.description)}</textarea>
                    </div>
                    
                    <div id="questions-list" class="space-y-4">
                        ${form.questions.length === 0 ? 
                            `<div class="text-center py-10 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
                                <p>No questions yet.</p> <p class="text-sm">Use the sidebar to add your first question.</p>
                             </div>` : 
                             form.questions.map((q, idx) => renderQuestionEditor(q, idx, form)).join('')}
                    </div>
                `;
            } else if (state.builderTab === 'design') {
                return `
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="palette" class="w-5 h-5"></i> Theme Gallery</h2>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                ${THEMES.map(t => `
                                    <button onclick="window.updateFormTheme('${t.id}')" class="h-24 rounded-lg border-2 flex flex-col overflow-hidden transition ${form.theme === t.id ? 'border-gray-800 ring-2 ring-gray-200' : 'border-transparent hover:scale-105'}">
                                        <div class="h-1/2 w-full ${t.primary}"></div>
                                        <div class="h-1/2 w-full bg-white flex items-center justify-center text-xs font-medium uppercase text-gray-500">${t.id}</div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="bg-white rounded-lg shadow p-6 space-y-6">
                         <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="settings" class="w-5 h-5"></i> Form Settings</h2>
                         ${renderToggle('Quiz Mode', 'Enable points and correct answers', form.settings.isQuiz, 'isQuiz')}
                         ${renderToggle('Accepting Responses', 'Allow users to submit', form.settings.active, 'active')}
                         ${renderToggle('Anonymous Responses', 'Don\'t collect user IDs', form.settings.anonymous, 'anonymous')}
                         
                         <div class="pt-4 border-t border-gray-100">
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-1">Time Limit (Minutes)</label>
                                    <input type="number" min="1" value="${form.settings.timeLimit || ''}" onchange="window.updateFormSetting('timeLimit', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-teal-500" placeholder="No limit">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-1">Access Password</label>
                                    <input type="text" value="${form.settings.accessPassword || ''}" onchange="window.updateFormSetting('accessPassword', this.value)" class="w-full p-2 border border-gray-300 rounded focus:ring-teal-500" placeholder="Optional lock">
                                </div>
                             </div>
                         </div>

                         <div class="pt-4 border-t border-gray-100">
                             <label class="block text-sm font-medium text-gray-900 mb-2">Custom Thank You Message</label>
                             <textarea 
                                onchange="window.updateFormSetting('thankYouMessage', this.value)"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none text-sm"
                                rows="3"
                                placeholder="Thank you! Your response has been recorded."
                             >${escapeHtml(form.settings.thankYouMessage || '')}</textarea>
                         </div>
                    </div>
                `;
            }
        }

        function renderToggle(title, desc, value, key) {
            return `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                     <div>
                       <div class="font-medium text-gray-900">${title}</div>
                       <div class="text-sm text-gray-500">${desc}</div>
                     </div>
                     <button onclick="window.updateFormSetting('${key}', ${!value})" class="w-12 h-6 rounded-full transition-colors relative ${value ? 'bg-teal-600' : 'bg-gray-300'}">
                       <div class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform ${value ? 'translate-x-6' : ''}"></div>
                     </button>
                </div>
            `;
        }

        function renderQuestionEditor(q, idx, form) {
            const previousQuestions = form.questions.slice(0, idx).filter(pq => pq.type === 'choice' || pq.type === 'likert');
            const isLogicOpen = state.logicMenuOpenId === q.id;
            const isQuiz = form.settings.isQuiz;

            let optionsHtml = '';
            if (q.type === 'choice' || q.type === 'likert') {
                optionsHtml = `
                    <div class="space-y-2 ml-4 border-l-2 border-gray-100 pl-4 mt-2">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-semibold text-gray-500 uppercase">Options</label>
                            ${q.type === 'choice' ? `
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="checkbox" ${q.shuffleOptions ? 'checked' : ''} onchange="window.updateQuestion('${q.id}', 'shuffleOptions', this.checked)" class="rounded text-teal-600 w-3 h-3">
                                <span class="text-xs text-gray-400">Shuffle</span>
                            </label>` : ''}
                        </div>
                        ${q.options.map((opt, i) => `
                            <div class="flex items-center gap-2 group">
                                <div class="w-4 h-4 border-2 rounded-full ${isQuiz && q.correctAnswer === opt ? 'border-green-500 bg-green-500' : 'border-gray-300'}"></div>
                                <input value="${escapeHtml(opt)}" onchange="window.updateOption('${q.id}', ${i}, this.value)" class="flex-1 bg-transparent border-none focus:ring-0 text-sm text-gray-700 placeholder-gray-300 outline-none" placeholder="Option ${i+1}" />
                                ${isQuiz ? `<button onclick="window.setCorrectAnswer('${q.id}', '${escapeHtml(opt)}')" class="text-xs px-2 py-0.5 rounded ${q.correctAnswer === opt ? 'bg-green-100 text-green-700' : 'text-gray-300 hover:text-gray-500'}">Correct</button>` : ''}
                                <button onclick="window.removeOption('${q.id}', ${i})" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                            </div>
                        `).join('')}
                        <button onclick="window.addOption('${q.id}')" class="text-sm text-blue-600 hover:underline flex items-center gap-1 mt-2"><i data-lucide="plus" class="w-3 h-3"></i> Add Option</button>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 group transition-all duration-200 hover:shadow-md relative">
                    <div class="p-4 flex items-start gap-4">
                         <span class="flex-shrink-0 mt-2 w-6 h-6 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center text-xs font-bold">${idx + 1}</span>
                         <div class="flex-1 space-y-3">
                             <div class="flex gap-4">
                                 <div class="flex-1">
                                     <input value="${escapeHtml(q.title)}" onchange="window.updateQuestion('${q.id}', 'title', this.value)" class="w-full bg-gray-50 border border-gray-200 rounded p-3 focus:bg-white focus:ring-2 focus:ring-teal-500 focus:border-transparent transition outline-none" placeholder="Question Text" />
                                     ${q.visibleIf ? `<div class="mt-1 text-xs bg-amber-50 text-amber-700 inline-flex items-center gap-1 px-2 py-1 rounded"><i data-lucide="share-2" class="w-3 h-3"></i> Shows if Q${form.questions.findIndex(x=>x.id===q.visibleIf.questionId)+1} is "${escapeHtml(q.visibleIf.value)}"</div>` : ''}
                                 </div>
                                 <select onchange="window.updateQuestion('${q.id}', 'type', this.value)" class="w-40 p-2 border border-gray-200 rounded bg-white text-sm outline-none h-11">
                                     ${QUESTION_TYPES.map(t => `<option value="${t.id}" ${q.type === t.id ? 'selected' : ''}>${t.label}</option>`).join('')}
                                 </select>
                             </div>
                             
                             ${optionsHtml}
                             
                             <div class="pt-4 border-t border-gray-100 flex items-center justify-between gap-4">
                                <div class="flex items-center gap-4 text-sm text-gray-600">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="checkbox" ${q.required ? 'checked' : ''} onchange="window.updateQuestion('${q.id}', 'required', this.checked)" class="rounded border-gray-300 text-teal-600 focus:ring-teal-500" />
                                        Required
                                    </label>
                                    ${isQuiz ? `
                                    <div class="flex items-center gap-2 border-l pl-4 border-gray-200">
                                        <span class="font-medium">Points:</span>
                                        <input type="number" min="0" value="${q.points || 0}" onchange="window.updateQuestion('${q.id}', 'points', parseInt(this.value))" class="w-16 p-1 border border-gray-200 rounded text-center outline-none" />
                                    </div>` : ''}
                                </div>
                                <div class="flex items-center gap-2">
                                    ${previousQuestions.length > 0 ? `
                                    <button onclick="window.toggleLogicMenu('${q.id}')" class="p-2 rounded hover:bg-gray-100 ${q.visibleIf || isLogicOpen ? 'text-amber-600 bg-amber-50' : 'text-gray-400'}" title="Add Logic">
                                        <i data-lucide="share-2" class="w-4 h-4"></i>
                                    </button>` : ''}
                                    <div class="h-4 w-px bg-gray-200 mx-1"></div>
                                    <button onclick="window.deleteQuestion('${q.id}')" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    <div class="flex flex-col">
                                        <button onclick="window.moveQuestion(${idx}, 'up')" ${idx === 0 ? 'disabled' : ''} class="text-gray-400 hover:text-gray-800 disabled:opacity-30"><i data-lucide="chevron-up" class="w-4 h-4"></i></button>
                                        <button onclick="window.moveQuestion(${idx}, 'down')" ${idx === form.questions.length - 1 ? 'disabled' : ''} class="text-gray-400 hover:text-gray-800 disabled:opacity-30"><i data-lucide="chevron-down" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                             </div>
                         </div>
                    </div>
                    
                    ${isLogicOpen ? `
                    <div class="absolute bottom-16 right-4 w-72 bg-white border border-gray-200 shadow-xl rounded-lg p-4 z-20 animate-in fade-in slide-in-from-bottom-2">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Show this question if...</h4>
                            <button onclick="window.toggleLogicMenu(null)" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Question</label>
                                <select id="logic-q-${q.id}" onchange="window.updateLogicUI('${q.id}')" class="w-full text-sm border border-gray-300 rounded p-1.5 outline-none">
                                    <option value="">Select question...</option>
                                    ${previousQuestions.map(pq => `<option value="${pq.id}" ${q.visibleIf?.questionId === pq.id ? 'selected' : ''}>${idx > 0 ? (form.questions.findIndex(x=>x.id===pq.id)+1) + '. ' : ''}${escapeHtml(pq.title)}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">Answer is</label>
                                <select id="logic-v-${q.id}" class="w-full text-sm border border-gray-300 rounded p-1.5 outline-none">
                                    ${q.visibleIf ? (previousQuestions.find(pq => pq.id === q.visibleIf.questionId)?.options || []).map(o => `<option value="${escapeHtml(o)}" ${q.visibleIf.value === o ? 'selected' : ''}>${escapeHtml(o)}</option>`).join('') : '<option disabled selected>Select question first</option>'}
                                </select>
                            </div>
                            <div class="flex justify-between pt-2">
                                <button onclick="window.updateQuestion('${q.id}', 'visibleIf', null); window.toggleLogicMenu(null);" class="text-xs text-red-500 hover:text-red-700">Clear Logic</button>
                                <button onclick="window.saveLogic('${q.id}')" class="text-xs bg-teal-600 text-white px-3 py-1.5 rounded hover:bg-teal-700">Save</button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // --- Viewer View ---
        function renderViewer(container, isPreview) {
             const f = state.currentForm || getLocalForms().find(x => x.id === state.activeFormId);
             
             if (!f) {
                 container.innerHTML = '<div class="p-8 text-center">Form not found.</div>';
                 return;
             }
             
             const theme = THEMES.find(t => t.id === f.theme) || THEMES[0];
             const bgStyle = f.backgroundImage ? `background-image: url('${f.backgroundImage}'); background-size: cover;` : f.backgroundColor ? `background-color: ${f.backgroundColor};` : '';
             const bgClass = (!f.backgroundImage && !f.backgroundColor) ? theme.secondary : '';
             
             // Timer Logic
             let timerHtml = '';
             if (!isPreview && f.settings.timeLimit && f.settings.timeLimit > 0) {
                 const seconds = f.settings.timeLimit * 60;
                 window.startTimer(seconds);
                 timerHtml = `<div id="quiz-timer" class="fixed top-14 right-4 bg-gray-900 text-white px-3 py-1 rounded shadow-lg font-mono z-40">00:00</div>`;
             }

             container.innerHTML = `
                <div class="min-h-screen ${bgClass} w-full overflow-y-auto transition-colors duration-500" style="${bgStyle}">
                    <div class="fixed top-0 left-0 w-full z-30 h-1 bg-gray-200"><div id="progress-bar" class="h-full ${theme.primary} transition-all duration-500" style="width: 0%"></div></div>
                    ${timerHtml}
                    ${isPreview ? `
                    <div class="bg-white/90 backdrop-blur border-b border-gray-200 px-4 py-2 flex justify-between items-center sticky top-0 z-20 mt-1">
                        <div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">PREVIEW MODE</span></div>
                        <div class="flex gap-2"><button onclick="window.openBuilder('${f.id}')" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">Edit</button><button onclick="window.loadDashboard()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                    </div>` : `
                     <button onclick="window.loadDashboard()" class="fixed top-4 right-4 z-50 p-2 bg-white/50 backdrop-blur rounded-full hover:bg-white text-gray-600 shadow-sm"><i data-lucide="x" class="w-6 h-6"></i></button>
                    `}
                    
                    <div class="max-w-3xl mx-auto p-4 md:p-8 space-y-4 pt-12">
                        <div class="bg-white rounded-lg shadow-sm border-t-8 p-8" style="border-top-color: ${theme.primary.replace('bg-', '') === 'bg-slate-800' ? '#1e293b' : ''};">
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">${escapeHtml(f.title)}</h1>
                            <p class="text-gray-600 whitespace-pre-wrap">${escapeHtml(f.description)}</p>
                        </div>

                        <form id="public-form" onsubmit="window.submitForm(event)" onchange="window.handleFormChange()">
                            <div class="space-y-4">
                                ${f.questions.map(q => renderViewerQuestion(q, f, theme)).join('')}
                            </div>
                            <div class="pt-8 pb-12">
                                <button type="submit" class="w-full sm:w-auto px-8 py-3 rounded-lg text-white font-semibold shadow-md hover:shadow-lg transition transform hover:-translate-y-0.5 ${theme.primary} ${theme.hover}">Submit Form</button>
                            </div>
                        </form>
                    </div>
                </div>
             `;
        }

        window.startTimer = (duration) => {
            let timer = duration, minutes, seconds;
            if(state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                
                const el = document.getElementById('quiz-timer');
                if(el) el.textContent = minutes + ":" + seconds;
                
                if (timer < 30 && el) el.classList.add('bg-red-600'); // Urgent

                if (--timer < 0) {
                    clearInterval(state.timerInterval);
                    alert("Time's up! Submitting answers.");
                    document.getElementById('public-form').dispatchEvent(new Event('submit'));
                }
            }, 1000);
        };

        window.handleFormChange = () => { window.evaluateLogic(); window.updateProgressBar(); }

        window.updateProgressBar = () => {
            const form = document.getElementById('public-form');
            if(!form) return;
            const total = state.currentForm ? state.currentForm.questions.length : 0;
            if (total === 0) return;
            // Rough estimate of completion
            const fd = new FormData(form);
            const answeredKeys = new Set();
            for(let [k,v] of fd.entries()) { if(v && v.trim() !== '') answeredKeys.add(k.split('_')[0]); }
            const filled = answeredKeys.size;
            const pct = Math.min(100, Math.round((filled / total) * 100));
            const bar = document.getElementById('progress-bar');
            if(bar) bar.style.width = `${pct}%`;
        }

        window.handleOtherSelection = (qId, isOther) => {
            const container = document.getElementById(`other-input-container-${qId}`);
            const input = document.getElementById(`other-input-${qId}`);
            if (!container || !input) return;
            if (isOther) { container.classList.remove('hidden'); input.required = true; input.focus(); } 
            else { container.classList.add('hidden'); input.required = false; input.value = ''; }
        };

        window.updateRangeValue = (qId, val) => { const el = document.getElementById(`range-val-${qId}`); if(el) el.innerText = val; }

        // --- File Upload Handler ---
        window.handleFileSelect = (qId, input) => {
            const file = input.files[0];
            const max = 500 * 1024; // 500KB limit for localStorage safety
            if(file.size > max) { alert("File too large (Max 500KB)"); input.value = ""; return; }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(`file-data-${qId}`).value = e.target.result;
                document.getElementById(`file-name-${qId}`).innerText = file.name;
            };
            reader.readAsDataURL(file);
        };

        // --- Signature Pad Logic ---
        window.initSignaturePads = () => {
            const pads = document.querySelectorAll('.signature-pad');
            pads.forEach(canvas => {
                const ctx = canvas.getContext('2d');
                let writing = false;
                const hiddenInput = document.getElementById(`sig-data-${canvas.dataset.qid}`);

                const getPos = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX || e.touches[0].clientX) - rect.left;
                    const y = (e.clientY || e.touches[0].clientY) - rect.top;
                    return {x, y};
                }

                const start = (e) => { writing = true; const {x,y} = getPos(e); ctx.beginPath(); ctx.moveTo(x,y); e.preventDefault(); }
                const move = (e) => { if(!writing) return; const {x,y} = getPos(e); ctx.lineTo(x,y); ctx.stroke(); e.preventDefault(); }
                const end = () => { writing = false; if(hiddenInput) hiddenInput.value = canvas.toDataURL(); }

                canvas.addEventListener('mousedown', start);
                canvas.addEventListener('mousemove', move);
                canvas.addEventListener('mouseup', end);
                canvas.addEventListener('touchstart', start);
                canvas.addEventListener('touchmove', move);
                canvas.addEventListener('touchend', end);
            });
        };
        
        window.clearSignature = (qId) => {
             const canvas = document.querySelector(`canvas[data-qid="${qId}"]`);
             const ctx = canvas.getContext('2d');
             ctx.clearRect(0,0, canvas.width, canvas.height);
             document.getElementById(`sig-data-${qId}`).value = '';
        };

        function renderViewerQuestion(q, form, theme) {
            let inputHtml = '';
            
            if (q.type === 'text') {
                inputHtml = `<input type="text" name="${q.id}" class="w-full p-3 border-b-2 bg-gray-50 focus:bg-white outline-none transition ${theme.border} focus:border-opacity-100 border-opacity-20" placeholder="Your answer" ${q.required ? 'required' : ''}>`;
            } else if (q.type === 'paragraph') {
                inputHtml = `<textarea name="${q.id}" rows="4" class="w-full p-3 border-2 bg-gray-50 focus:bg-white outline-none rounded-lg transition ${theme.border} focus:border-opacity-100 border-opacity-20" placeholder="Type your answer here..." ${q.required ? 'required' : ''}></textarea>`;
            } else if (q.type === 'email') {
                inputHtml = `<input type="email" name="${q.id}" class="w-full p-3 border-b-2 bg-gray-50 focus:bg-white outline-none transition ${theme.border} focus:border-opacity-100 border-opacity-20" placeholder="name@example.com" ${q.required ? 'required' : ''}>`;
            } else if (q.type === 'range') {
                inputHtml = `
                    <div class="flex items-center gap-4 pt-4">
                        <span class="text-gray-400 text-xs">0</span>
                        <input type="range" name="${q.id}" min="0" max="100" value="50" oninput="window.updateRangeValue('${q.id}', this.value)" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <span class="text-gray-400 text-xs">100</span>
                    </div>
                    <div class="text-center mt-2 font-bold text-lg text-gray-700" id="range-val-${q.id}">50</div>
                `;
            } else if (q.type === 'choice') {
                let optionsToRender = [...q.options];
                if (q.shuffleOptions && !form.settings.isAdminView) optionsToRender = optionsToRender.sort(() => Math.random() - 0.5);
                inputHtml = `<div class="space-y-2">
                    ${optionsToRender.map((opt, i) => {
                        const isOther = opt.toLowerCase() === 'other';
                        return `
                        <div>
                            <label class="flex items-center gap-3 p-3 border border-gray-200 rounded-lg cursor-pointer transition hover:bg-gray-50">
                                <input type="radio" name="${q.id}" value="${escapeHtml(opt)}" class="text-teal-600 focus:ring-teal-500" onchange="window.handleOtherSelection('${q.id}', ${isOther})" ${q.required ? 'required' : ''}>
                                <span class="text-gray-700">${escapeHtml(opt)}</span>
                            </label>
                            ${isOther ? `<div id="other-input-container-${q.id}" class="hidden ml-8 mt-2"><input type="text" name="${q.id}_other_text" id="other-input-${q.id}" class="w-full bg-transparent border-b border-gray-400 text-gray-700 placeholder-gray-400 outline-none focus:border-teal-600 py-1 transition" placeholder="Please specify..."></div>` : ''}
                        </div>
                    `}).join('')}
                </div>`;
            } else if (q.type === 'likert') {
                 inputHtml = `<div class="space-y-2">
                    ${q.options.map((opt, i) => `<label class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer"><span class="text-gray-700">${escapeHtml(opt)}</span><input type="radio" name="${q.id}" value="${escapeHtml(opt)}" ${q.required ? 'required' : ''}></label>`).join('')}
                </div>`;
            } else if (q.type === 'rating') {
                inputHtml = `<div class="flex gap-2 rating-group">${[1,2,3,4,5].map(v => `<label class="cursor-pointer"><input type="radio" name="${q.id}" value="${v}" class="peer sr-only" ${q.required ? 'required' : ''}><i data-lucide="star" class="w-8 h-8 text-gray-300 peer-checked:text-yellow-400 peer-checked:fill-yellow-400 hover:text-yellow-200"></i></label>`).join('')}</div>`;
            } else if (q.type === 'date') {
                 inputHtml = `<input type="date" name="${q.id}" class="p-2 border border-gray-300 rounded" ${q.required ? 'required' : ''}>`;
            } else if (q.type === 'nps') {
                inputHtml = `<div class="flex flex-wrap gap-1">${[0,1,2,3,4,5,6,7,8,9,10].map(s => `<label class="cursor-pointer"><input type="radio" name="${q.id}" value="${s}" class="peer sr-only" ${q.required ? 'required' : ''}><div class="w-10 h-10 rounded border border-gray-300 flex items-center justify-center peer-checked:${theme.primary} peer-checked:text-white peer-checked:border-transparent hover:border-gray-800 transition">${s}</div></label>`).join('')}</div>`;
            } else if (q.type === 'file') {
                inputHtml = `
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition relative">
                        <input type="file" accept="image/*,.pdf" onchange="window.handleFileSelect('${q.id}', this)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" ${q.required ? 'required' : ''}>
                        <i data-lucide="upload-cloud" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                        <div class="text-sm text-gray-500" id="file-name-${q.id}">Click to upload (Max 500KB)</div>
                        <input type="hidden" name="${q.id}" id="file-data-${q.id}">
                    </div>
                `;
            } else if (q.type === 'signature') {
                inputHtml = `
                    <div class="border border-gray-300 rounded-lg bg-white overflow-hidden">
                        <canvas class="signature-pad w-full h-40" data-qid="${q.id}" width="600" height="160"></canvas>
                        <div class="bg-gray-50 border-t border-gray-200 p-2 flex justify-between items-center text-xs text-gray-500">
                            <span>Sign above</span>
                            <button type="button" onclick="window.clearSignature('${q.id}')" class="text-red-500 hover:underline">Clear</button>
                        </div>
                        <input type="hidden" name="${q.id}" id="sig-data-${q.id}" ${q.required ? 'required' : ''}>
                    </div>
                `;
            }

            return `
                <div id="question-container-${q.id}" class="bg-white rounded-lg shadow-sm p-6 md:p-8 fade-in">
                    ${q.mediaUrl ? `<img src="${escapeHtml(q.mediaUrl)}" class="max-h-64 rounded-lg mb-4 object-contain">` : ''}
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-900">${escapeHtml(q.title)} ${q.required ? '<span class="text-red-500">*</span>' : ''}</h3>
                         ${form.settings.isQuiz ? `<span class="text-xs text-gray-400">${q.points || 0} Points</span>` : ''}
                    </div>
                    ${inputHtml}
                </div>
            `;
        }
        
        // --- Logic & Branching ---
        window.toggleLogicMenu = (qId) => { state.logicMenuOpenId = qId; render(); };
        window.updateLogicUI = (qId) => {
            const triggerQId = document.getElementById(`logic-q-${qId}`).value;
            const targetSelect = document.getElementById(`logic-v-${qId}`);
            if(!triggerQId) { targetSelect.innerHTML = '<option disabled selected>Select question first</option>'; return; }
            const triggerQ = state.currentForm.questions.find(q => q.id === triggerQId);
            if(triggerQ) { targetSelect.innerHTML = triggerQ.options.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join(''); }
        };

        window.saveLogic = (qId) => {
            const triggerQId = document.getElementById(`logic-q-${qId}`).value;
            const value = document.getElementById(`logic-v-${qId}`).value;
            if(triggerQId && value) { window.updateQuestion(qId, 'visibleIf', { questionId: triggerQId, value }); window.toggleLogicMenu(null); }
            else { alert("Please select both a question and an answer."); }
        };

        window.evaluateLogic = () => {
            const form = state.currentForm || state.forms.find(f => f.id === state.activeFormId);
            if(!form) return;
            const fd = new FormData(document.getElementById('public-form'));
            const answers = {};
            for(let [k,v] of fd.entries()) answers[k] = v;
            form.questions.forEach(q => {
                const container = document.getElementById(`question-container-${q.id}`);
                if(!container) return;
                if (q.visibleIf) {
                    const { questionId, value } = q.visibleIf;
                    if (answers[questionId] === value) { container.style.display = 'block'; container.querySelectorAll('input, select, textarea').forEach(el => el.disabled = false); } 
                    else { container.style.display = 'none'; container.querySelectorAll('input, select, textarea').forEach(el => el.disabled = true); }
                } else { container.style.display = 'block'; }
            });
        };

        // --- Results View (Admin Only) ---
        function mountResults(formId) {
             if(state.role !== 'admin') { alert("Admin access required."); return; }
             state.view = 'results';
             state.activeFormId = formId;
             const form = getLocalForms().find(f => f.id === formId);
             if (!form) { alert("Form not found"); mountDashboard(); return; }
             state.currentForm = form;
             state.responses = getLocalResponses().filter(r => r.formId === formId);
             render();
        }

        function renderResults(container) {
             if(!state.currentForm) return;
             const f = state.currentForm;
             const count = state.responses.length;
             const avg = state.responses.reduce((a,b) => a + (b.score || 0), 0) / (count || 1);
             
             container.innerHTML = `
                <div class="min-h-screen bg-gray-50 overflow-y-auto">
                    <div class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between sticky top-0 z-10">
                        <div class="flex items-center gap-4">
                            <button onclick="window.loadDashboard()" class="p-2 hover:bg-gray-100 rounded-full"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            <div>
                                <h1 class="text-xl font-bold text-gray-800">${escapeHtml(f.title)}</h1>
                                <p class="text-sm text-gray-500">Results Dashboard</p>
                            </div>
                        </div>
                        <div class="flex gap-4 items-center">
                            <div class="text-sm text-gray-500 mr-2">${count} Responses</div>
                            <button onclick="window.downloadResponsesCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md flex items-center gap-2 transition shadow-sm text-sm">
                                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Download Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="max-w-6xl mx-auto p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4">
                                <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="users" class="w-6 h-6"></i></div>
                                <div><div class="text-2xl font-bold">${count}</div><div class="text-sm text-gray-500">Total Responses</div></div>
                            </div>
                            ${f.settings.isQuiz ? `
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4">
                                <div class="p-3 bg-purple-50 text-purple-600 rounded-lg"><i data-lucide="star" class="w-6 h-6"></i></div>
                                <div><div class="text-2xl font-bold">${avg.toFixed(1)}</div><div class="text-sm text-gray-500">Average Score</div></div>
                            </div>` : ''}
                        </div>
                        
                        ${f.questions.map((q, i) => {
                             const counts = {};
                             state.responses.forEach(r => { const ans = r.answers[q.id]; if(ans) counts[ans] = (counts[ans] || 0) + 1; });
                             return `
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                    <h3 class="font-semibold text-gray-800 mb-4 flex gap-2"><span class="text-gray-400">${i+1}.</span> ${escapeHtml(q.title)}</h3>
                                    ${(q.type === 'choice' || q.type === 'likert') ? `
                                        <div class="space-y-2">
                                            ${q.options.map(opt => {
                                                const c = counts[opt] || 0;
                                                const pct = count ? Math.round((c/count)*100) : 0;
                                                const isCorrect = f.settings.isQuiz && q.correctAnswer === opt;
                                                return `
                                                    <div class="relative">
                                                        <div class="flex justify-between text-sm text-gray-600 mb-1 relative z-10">
                                                            <span>${escapeHtml(opt)} ${isCorrect ? '<span class="text-green-600 font-bold ml-2">(Correct)</span>' : ''}</span>
                                                            <span>${c} (${pct}%)</span>
                                                        </div>
                                                        <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
                                                            <div class="h-full ${isCorrect ? 'bg-green-500' : 'bg-blue-500'}" style="width: ${pct}%"></div>
                                                        </div>
                                                    </div>`;
                                            }).join('')}
                                        </div>
                                    ` : (q.type === 'signature') ? 
                                        `<div class="bg-gray-50 p-4 text-xs italic">Signatures captured. View in exported Excel.</div>` 
                                    : `<div class="bg-gray-50 rounded p-4 text-sm text-gray-500 italic">Text/Date/File inputs not visualized. Last entry: ${escapeHtml(state.responses[state.responses.length-1]?.answers[q.id] ? 'Captured' : '-')}</div>`}
                                </div>
                             `;
                        }).join('')}
                    </div>
                </div>
             `;
        }

        // --- Core Actions ---
        window.createForm = (type) => {
            if(state.role !== 'admin') return;
            const newForm = {
                id: generateId(),
                title: type === 'quiz' ? 'Untitled Quiz' : 'Untitled Form',
                description: 'Enter a description here.',
                type,
                theme: 'teal',
                questions: [],
                settings: { isQuiz: type === 'quiz', active: true, anonymous: true, allowMultiple: true, thankYouMessage: '', timeLimit: null, accessPassword: null },
                createdAt: Date.now(),
                updatedAt: Date.now(),
                authorId: state.user.uid
            };
            const forms = getLocalForms();
            forms.push(newForm);
            saveLocalForms(forms);
            mountBuilder(newForm.id);
        };

        window.duplicateForm = (e, id) => {
            if (typeof e === 'string' && !id) id = e; else if (e && e.stopPropagation) e.stopPropagation();
            if(state.role !== 'admin') return;
            const forms = getLocalForms();
            const original = forms.find(f => f.id === id);
            if (!original) return;
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = generateId();
            copy.title = `${copy.title} (Copy)`;
            copy.updatedAt = Date.now();
            forms.unshift(copy);
            saveLocalForms(forms);
            mountDashboard();
        };

        window.deleteForm = (e, id) => {
            e.stopPropagation();
            if(state.role !== 'admin') return;
            if(confirm('Delete form?')) {
                const forms = getLocalForms().filter(f => f.id !== id);
                saveLocalForms(forms);
                mountDashboard();
            }
        };

        window.openBuilder = (id) => mountBuilder(id);
        window.openPreview = (id) => { state.activeFormId = id; state.view = 'preview'; render(); };
        window.openResults = (id) => mountResults(id);
        window.loadDashboard = () => mountDashboard();
        
        window.setBuilderTab = (tab) => { state.builderTab = tab; render(); };
        window.updateFormTitle = (val) => updateForm({ title: val });
        window.updateFormDesc = (val) => updateForm({ description: val });
        window.updateFormTheme = (id) => updateForm({ theme: id });
        window.updateFormSetting = (key, val) => { const s = { ...state.currentForm.settings, [key]: val }; updateForm({ settings: s }); };
        
        function updateForm(updates) {
             const updatedForm = { ...state.currentForm, ...updates, updatedAt: Date.now() };
             state.currentForm = updatedForm;
             const forms = getLocalForms().map(f => f.id === updatedForm.id ? updatedForm : f);
             saveLocalForms(forms);
             if(state.view === 'builder') render();
        }
        
        window.addQuestion = (type) => {
             const newQ = {
                id: generateId(),
                type,
                title: 'New Question',
                required: false,
                options: (type === 'choice' || type === 'likert') ? ['Option 1', 'Option 2'] : [],
                correctAnswer: null, points: 1, visibleIf: null, shuffleOptions: false
             };
             updateForm({ questions: [...state.currentForm.questions, newQ] });
        };
        
        window.deleteQuestion = (id) => updateForm({ questions: state.currentForm.questions.filter(q => q.id !== id) });
        window.moveQuestion = (idx, dir) => {
             const arr = [...state.currentForm.questions];
             if (dir === 'up' && idx > 0) [arr[idx], arr[idx-1]] = [arr[idx-1], arr[idx]];
             if (dir === 'down' && idx < arr.length-1) [arr[idx], arr[idx+1]] = [arr[idx+1], arr[idx]];
             updateForm({ questions: arr });
        };
        
        window.updateQuestion = (qId, field, val) => {
             const arr = state.currentForm.questions.map(q => q.id === qId ? { ...q, [field]: val } : q);
             updateForm({ questions: arr });
        };

        window.addOption = (qId) => {
             const arr = state.currentForm.questions.map(q => {
                 if (q.id === qId) return { ...q, options: [...q.options, `Option ${q.options.length + 1}`] };
                 return q;
             });
             updateForm({ questions: arr });
        };
        
        window.updateOption = (qId, idx, val) => {
             const arr = state.currentForm.questions.map(q => {
                 if (q.id === qId) {
                     const opts = [...q.options];
                     opts[idx] = val;
                     return { ...q, options: opts };
                 }
                 return q;
             });
             updateForm({ questions: arr });
        };

        window.removeOption = (qId, idx) => {
             const arr = state.currentForm.questions.map(q => {
                 if (q.id === qId) return { ...q, options: q.options.filter((_, i) => i !== idx) };
                 return q;
             });
             updateForm({ questions: arr });
        };
        
        window.setCorrectAnswer = (qId, val) => window.updateQuestion(qId, 'correctAnswer', val);
        
        // Viewer Actions
        window.submitForm = (e) => {
            e.preventDefault();
            if(state.timerInterval) clearInterval(state.timerInterval);
            const fd = new FormData(e.target);
            const rawAnswers = {};
            for(let [k,v] of fd.entries()) rawAnswers[k] = v;
            
            const f = state.currentForm || state.forms.find(x => x.id === state.activeFormId);
            const finalAnswers = {};
            f.questions.forEach(q => {
                let ans = rawAnswers[q.id];
                if (ans === 'Other' && rawAnswers[`${q.id}_other_text`]) ans = `Other: ${rawAnswers[`${q.id}_other_text`]}`;
                if (ans) finalAnswers[q.id] = ans;
            });

            let score = 0;
            if(f.settings.isQuiz) {
                f.questions.forEach(q => { if(q.correctAnswer && finalAnswers[q.id] === q.correctAnswer) score += (q.points || 0); });
            }
            
            const response = {
                formId: f.id,
                answers: finalAnswers,
                score,
                userId: f.settings.anonymous ? 'anon' : state.user.uid,
                submittedAt: Date.now()
            };
            
            saveLocalResponse(response);

            // CSV Logic
            try {
                const headers = ['Date Submitted', 'Form Title'];
                if (f.settings.isQuiz) headers.push('Score');
                f.questions.forEach(q => headers.push(q.title));

                const row = [ new Date().toLocaleString(), f.title ];
                if (f.settings.isQuiz) row.push(score);
                f.questions.forEach(q => {
                    let ans = finalAnswers[q.id] || '';
                    if (ans.startsWith('data:image')) ans = "(Image Data)";
                    row.push(ans);
                });

                const escapeCSV = (val) => {
                    const str = String(val || '');
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) return `"${str.replace(/"/g, '""')}"`;
                    return str;
                };

                const csvContent = headers.map(escapeCSV).join(',') + '\n' + row.map(escapeCSV).join(',');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `${f.title.replace(/[^a-z0-9]/gi, '_')}_MyResponse.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) { console.error("Error creating excel file:", err); }
            
            const thankYouMsg = f.settings.thankYouMessage || 'Response submitted locally.';
            document.getElementById('app').innerHTML = `
                <div class="h-full flex items-center justify-center bg-gray-50">
                    <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-md w-full">
                        <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800">Thank You!</h2>
                        <p class="text-gray-600 mb-6 whitespace-pre-wrap">${escapeHtml(thankYouMsg)}</p>
                        ${f.settings.isQuiz ? `<div class="text-4xl font-bold text-gray-900 mb-6">${score} / ${f.questions.reduce((a,q)=>a+(q.points||0),0)}</div>` : ''}
                        <button onclick="window.loadDashboard()" class="text-gray-500 hover:underline">Return Home</button>
                    </div>
                </div>
            `;
            if(window.lucide) lucide.createIcons();
        };

        window.downloadResponsesCSV = () => {
            const f = state.currentForm;
            const responses = state.responses;
            if(!responses || responses.length === 0) { alert("No responses to download."); return; }
            const headers = ['Submitted At', 'User ID', 'Score'];
            f.questions.forEach(q => headers.push(q.title));
            const rows = responses.map(r => {
                const row = [ new Date(r.submittedAt).toLocaleString(), r.userId, r.score || 0 ];
                f.questions.forEach(q => {
                    let ans = r.answers[q.id] || '';
                    if (ans.startsWith('data:image')) ans = "(Image/Sig Data)";
                    row.push(ans);
                });
                return row;
            });
            const escape = (val) => { const str = String(val || ''); if (str.includes(',') || str.includes('"') || str.includes('\n')) return `"${str.replace(/"/g, '""')}"`; return str; };
            const csvContent = [ headers.map(escape).join(','), ...rows.map(r => r.map(escape).join(',')) ].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `${f.title.replace(/[^a-z0-9]/gi, '_')}_results.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.downloadFormCode = () => {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RiForm_Builder_v3.html`;
            a.click();
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>